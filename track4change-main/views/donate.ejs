<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .donate-hero {
            min-height: 40vh;
            background: linear-gradient(135deg, #10b981 0%, #f59e0b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 7rem 2rem 2rem;
            position: relative;
            overflow: hidden;
            margin-top: 100px;
        }
        .donate-hero-content {
            max-width: 700px;
            position: relative;
            z-index: 1;
        }
        .donate-hero h1 {
            font-size: 2.8rem;
            color: white;
            margin-bottom: 1rem;
            animation: fadeInUp 0.8s ease;
        }
        .donate-hero p {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 2rem;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }
        .donate-section-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 2rem;
            color: #1f2937;
        }
        .donate-search-form {
            max-width: 400px;
            margin: 0 auto 2rem;
            display: flex;
            gap: 1rem;
        }
        .donate-search-form input {
            flex: 1;
            border: none;
            border-radius: 20px;
            padding: 1rem;
            background: #f3f4f6;
            font-size: 1rem;
        }
        .donate-search-form button {
            border-radius: 50px;
            padding: 0.75rem 2rem;
            background: white;
            color: #10b981;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 16px rgba(102,126,234,0.08);
            transition: all 0.3s;
        }
        .donate-search-form button:hover {
            background: #10b981;
            color: white;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .feature-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        .feature-card p {
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        .donate-form-input {
            width: 100%;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            border: 1px solid #eee;
            padding: 0.5rem;
            font-size: 1rem;
        }
        .cta-button {
            display: inline-block;
            padding: 0.75rem 2rem;
            background: #10b981;
            color: white;
            border-radius: 50px;
            font-weight: bold;
            border: none;
            font-size: 1rem;
            box-shadow: 0 4px 16px rgba(102,126,234,0.08);
            transition: all 0.3s;
        }
        .cta-button:hover {
            background: #764ba2;
        }
        .impact {
            padding: 4rem 5%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            text-align: center;
        }
        .impact-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .impact h2 {
            font-size: 2rem;
            margin-bottom: 2rem;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }
        .stat-label {
            color: rgba(255,255,255,0.9);
            margin-top: 0.5rem;
        }
        @media (max-width: 768px) {
            .donate-hero {
                margin-top: 80px;
            }
            .donate-hero h1 { font-size: 2rem; }
            .feature-grid { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <%- include('partials/header', { user: user, currentPage: currentPage }) %>

    <section class="donate-hero">
        <div class="donate-hero-content">
            <h1>Donate Food & Reduce Waste</h1>
            <p>Share your surplus food with the community and make an impact!</p>
        </div>
    </section>

        <!-- Postal code callout -->
        <div style="max-width:1200px;margin:1rem auto;padding:0 1rem;">
            <% if (!user || !user.postalCode) { %>
                <div style="background:#fff8e6;border:1px solid #fde68a;padding:0.75rem;border-radius:10px;max-width:560px;margin:0 auto;text-align:center;">
                    <strong></strong> Choose your postal code to find nearby food banks. <a href="/donate/locate">Choose postal code</a>
                </div>
            <% } %>
        </div>

    <section class="features">
        <h2 class="donate-section-title">Your Items Available for Donation</h2>
        <form method="GET" action="/donate" class="donate-search-form">
            <input type="text" name="q" placeholder="Search items..." value="<%= searchQuery %>" />
            <button type="submit">Search</button>
        </form>
        <div class="feature-grid">
            <% if (userItems.length === 0) { %>
                <div class="feature-card" style="text-align:center;">
                    <p>No items found.</p>
                </div>
            <% } else { %>
                <% userItems.forEach(item => { %>
                    <div class="feature-card" id="item-<%= item._id %>">
                        <h3><%= item.name %></h3>
                        <p>Category: <%= item.category %></p>
                        <p>Expires: <%= item.expiryDate.toDateString() %></p>
                        <form class="donate-form" data-item-id="<%= item._id %>" onsubmit="handleDonate(event, '<%= item._id %>')">
                            <input type="text" name="pickupLocation" class="donate-form-input" placeholder="Pickup location (optional)">
                            <input type="text" name="notes" class="donate-form-input" placeholder="Notes (optional)">
                            <button type="submit" class="cta-button" style="width:100%;">Donate</button>
                        </form>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </section>

    <section class="features" style="background:#f3f4f6;">
        <h2 class="donate-section-title">Community Donations</h2>
        <div class="feature-grid">
            <% if (communityItems.length === 0) { %>
                <div class="feature-card" style="text-align:center;">
                    <p>No community donations available.</p>
                </div>
            <% } else { %>
                <% communityItems.forEach(item => { %>
                    <div class="feature-card" id="community-item-<%= item._id %>">
                        <h3><%= item.name %></h3>
                        <p>Category: <%= item.category %></p>
                        <p>Expires: <%= item.expiryDate.toDateString() %></p>
                        <p>Donor: <%= item.username %></p>
                        <p>Pickup: <%= item.pickupLocation %></p>
                        <p><%= item.notes %></p>
                        <form onsubmit="handleClaim(event, '<%= item._id %>')">
                            <button type="submit" class="cta-button" style="width:100%;">Claim</button>
                        </form>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </section>

    <section class="impact">
        <div class="impact-content">
            <h2>Your Impact</h2>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number"><%= userImpact.itemsSaved %></div>
                    <div class="stat-label">Items Saved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><%= userImpact.itemsShared %></div>
                    <div class="stat-label">Items Shared</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><%= userImpact.co2SavedKg %>kg</div>
                    <div class="stat-label">COâ‚‚ Saved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number"><%= userImpact.waterSavedLiters %>L</div>
                    <div class="stat-label">Water Saved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$<%= userImpact.moneySavedDollars %></div>
                    <div class="stat-label">Money Saved</div>
                </div>
            </div>
        </div>
    </section>

    <%- include('partials/footer') %>

    <!-- Success Message Container -->
    <div id="successMessage" style="
        position: fixed;
        top: 90px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        font-weight: 600;
        font-size: 1rem;
        display: none;
        align-items: center;
        gap: 0.75rem;
        animation: slideDown 0.3s ease-out;
    ">
        <span style="font-size: 1.5rem;">âœ…</span>
        <span id="successMessageText">Item donated successfully!</span>
        <button onclick="hideSuccessMessage()" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 1rem;
        ">âœ–</button>
    </div>

    <style>
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }
    </style>

    <script>
        async function handleDonate(event, itemId) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const data = {
                pickupLocation: formData.get('pickupLocation'),
                notes: formData.get('notes')
            };

            // Disable the submit button to prevent double submission
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Donating...';

            try {
                const response = await fetch(`/api/donate/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message
                    showSuccessMessage('Item donated successfully! ðŸŽ‰');

                    // Remove the item card from the page with animation
                    const itemCard = document.getElementById(`item-${itemId}`);
                    if (itemCard) {
                        itemCard.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            itemCard.remove();

                            // Check if there are no more items
                            const remainingItems = document.querySelectorAll('.feature-card:not([style*="text-align"])');
                            if (remainingItems.length === 0) {
                                const featureGrid = document.querySelector('.feature-grid');
                                featureGrid.innerHTML = '<div class="feature-card" style="text-align:center;"><p>No items found.</p></div>';
                            }
                        }, 300);
                    }
                } else {
                    alert(result.error || 'Failed to donate item. Please try again.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Donate';
                }
            } catch (error) {
                console.error('Error donating item:', error);
                alert('An error occurred. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Donate';
            }
        }

        function showSuccessMessage(message) {
            const messageDiv = document.getElementById('successMessage');
            const messageText = document.getElementById('successMessageText');
            messageText.textContent = message;
            messageDiv.style.display = 'flex';

            // Auto-hide after 4 seconds
            setTimeout(() => {
                hideSuccessMessage();
            }, 4000);
        }

        function hideSuccessMessage() {
            const messageDiv = document.getElementById('successMessage');
            messageDiv.style.animation = 'slideUp 0.3s ease-out';
            setTimeout(() => {
                messageDiv.style.display = 'none';
                messageDiv.style.animation = 'slideDown 0.3s ease-out';
            }, 300);
        }

        async function handleClaim(event, itemId) {
            event.preventDefault();

            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Claiming...';

            try {
                const response = await fetch(`/api/donate/claim/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message
                    showSuccessMessage('Item claimed successfully! ðŸŽ‰');

                    // Remove the item card from the page with animation
                    const itemCard = document.getElementById(`community-item-${itemId}`);
                    if (itemCard) {
                        itemCard.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => {
                            itemCard.remove();

                            // Check if there are no more items in community section
                            const communitySection = document.querySelector('.features[style*="background:#f3f4f6"] .feature-grid');
                            const remainingItems = communitySection.querySelectorAll('.feature-card:not([style*="text-align"])');
                            if (remainingItems.length === 0) {
                                communitySection.innerHTML = '<div class="feature-card" style="text-align:center;"><p>No community donations available.</p></div>';
                            }
                        }, 300);
                    }
                } else {
                    alert(result.error || 'Failed to claim item. Please try again.');
                    submitButton.disabled = false;
                    submitButton.textContent = 'Claim';
                }
            } catch (error) {
                console.error('Error claiming item:', error);
                alert('An error occurred. Please try again.');
                submitButton.disabled = false;
                submitButton.textContent = 'Claim';
            }
        }
    </script>
</body>
</html>