<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Receipt - Track2Give</title>
    <link rel="stylesheet" href="/style.css" />
    <style>
      .scan-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 0 1rem;
        padding-top: 100px;
      }

      .upload-area {
        border: 3px dashed #10b981;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
        margin: 2rem 0;
      }

      .upload-area:hover {
        background: #f0f2ff;
        border-color: #764ba2;
      }

      .upload-area.dragover {
        background: #e8ebff;
        border-color: #10b981;
      }

      .camera-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }

      .preview-container {
        margin: 2rem 0;
        display: none;
      }

      .preview-image {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
      }

      .processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .processing-content {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
      }

      .spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #10b981;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results-container {
        display: none;
        margin-top: 2rem;
      }

      .food-item-result {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .item-info {
        flex: 1;
      }

      .item-expiry {
        text-align: right;
        color: #6b7280;
        font-size: 0.875rem;
      }
    </style>
  </head>
  <body>
    <%- include('partials/header') %>

    <main class="scan-container">
      <div style="text-align: center; margin-bottom: 2rem">
        <h1>ðŸ“· Scan Receipt</h1>
        <p style="color: #666; margin-top: 0.5rem">
          Upload or capture a photo of your grocery receipt to automatically
          track your food items
        </p>
      </div>

      <!-- Upload Area -->
      <div class="upload-area" id="uploadArea">
        <div class="camera-icon">ðŸ“¸</div>
        <h2 style="margin: 0 0 0.5rem 0; color: #1f2937">
          Take a Photo or Upload
        </h2>
        <p style="color: #6b7280; margin: 0 0 1.5rem 0">
          Click here to capture a photo with your camera or select an image from
          your device
        </p>
        <input
          type="file"
          id="receiptInput"
          accept="image/*"
          capture="environment"
          style="display: none"
        />
        <button
          class="btn btn-primary"
          onclick="event.stopPropagation(); document.getElementById('receiptInput').click();"
        >
          Choose File
        </button>
      </div>

      <!-- Preview Container -->
      <div class="preview-container" id="previewContainer">
        <h3>Preview</h3>
        <img id="previewImage" class="preview-image" alt="Receipt preview" />
        <div style="display: flex; gap: 1rem">
          <button class="btn btn-primary" id="processBtn" style="flex: 1">
            Process Receipt
          </button>
          <button class="btn btn-secondary" id="cancelBtn" style="flex: 1">
            Cancel
          </button>
        </div>
      </div>

      <!-- Results Container -->
      <div class="results-container" id="resultsContainer">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
          "
        >
          <h2 style="margin: 0">Extracted Items</h2>
          <span id="itemCount" class="badge badge-success">0 items</span>
        </div>
        <div id="resultsList"></div>
        <div style="margin-top: 2rem; display: flex; gap: 1rem">
          <button class="btn btn-primary" id="saveItemsBtn" style="flex: 1">
            Save All Items
          </button>
          <a
            href="/dashboard"
            class="btn btn-secondary"
            style="flex: 1; text-align: center"
          >
            Back to Dashboard
          </a>
        </div>
      </div>

      <!-- Processing Overlay -->
      <div class="processing-overlay" id="processingOverlay">
        <div class="processing-content">
          <div class="spinner"></div>
          <h3 style="margin: 0 0 0.5rem 0">Processing Receipt...</h3>
          <p style="color: #6b7280; margin: 0">
            Our AI is extracting food items from your receipt
          </p>
        </div>
      </div>

      <!-- Instructions -->
      <div class="card" style="margin-top: 3rem">
        <h3>ðŸ“‹ Tips for Best Results</h3>
        <ul style="color: #6b7280; line-height: 1.8">
          <li>Ensure the receipt is well-lit and readable</li>
          <li>Capture the entire receipt in the frame</li>
          <li>Avoid shadows or glare on the receipt</li>
          <li>Hold the camera steady for a clear image</li>
          <li>Make sure text is not blurry</li>
        </ul>
      </div>
    </main>

    <script>
      let selectedFile = null;
      let extractedData = null;

      const uploadArea = document.getElementById("uploadArea");
      const receiptInput = document.getElementById("receiptInput");
      const previewContainer = document.getElementById("previewContainer");
      const previewImage = document.getElementById("previewImage");
      const processBtn = document.getElementById("processBtn");
      const cancelBtn = document.getElementById("cancelBtn");
      const processingOverlay = document.getElementById("processingOverlay");
      const resultsContainer = document.getElementById("resultsContainer");
      const resultsList = document.getElementById("resultsList");
      const itemCount = document.getElementById("itemCount");
      const saveItemsBtn = document.getElementById("saveItemsBtn");

      // Drag and drop
      uploadArea.addEventListener("click", (e) => {
        // Only trigger file input when clicking the upload area itself,
        // not when clicking inner controls (prevents double prompts).
        if (e.target === uploadArea) {
          receiptInput.click();
        }
      });

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });

      // File selection
      receiptInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      function handleFileSelect(file) {
        if (!file.type.startsWith("image/")) {
          alert("Please select an image file");
          return;
        }

        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          uploadArea.style.display = "none";
          previewContainer.style.display = "block";
          resultsContainer.style.display = "none";
        };
        reader.readAsDataURL(file);
      }

      // Cancel button
      cancelBtn.addEventListener("click", () => {
        selectedFile = null;
        receiptInput.value = "";
        previewContainer.style.display = "none";
        uploadArea.style.display = "block";
      });

      // Process receipt
      processBtn.addEventListener("click", async () => {
        if (!selectedFile) {
          alert("Please select a file first");
          return;
        }

        const formData = new FormData();
        formData.append("receipt", selectedFile);

        processingOverlay.style.display = "flex";

        try {
          const response = await fetch("/api/scan/upload", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          processingOverlay.style.display = "none";

          if (result.success) {
            extractedData = result.data;
            displayResults(result.data);
          } else {
            alert(
              "Error processing receipt: " + (result.error || "Unknown error")
            );
            previewContainer.style.display = "none";
            uploadArea.style.display = "block";
          }
        } catch (error) {
          processingOverlay.style.display = "none";
          console.error("Error:", error);
          alert("Error uploading receipt: " + error.message);
          previewContainer.style.display = "none";
          uploadArea.style.display = "block";
        }
      });

      // Display results
      function displayResults(data) {
        previewContainer.style.display = "none";
        resultsContainer.style.display = "block";

        const items = data.extractedItems || [];
        itemCount.textContent = `${items.length} item${
          items.length !== 1 ? "s" : ""
        }`;

        resultsList.innerHTML = items
          .map((item) => {
            const expiryDate = new Date(item.expiryDate);
            const daysUntil = Math.ceil(
              (expiryDate - new Date()) / (1000 * 60 * 60 * 24)
            );

            return `
          <div class="food-item-result">
            <div class="item-info">
              <h4 style="margin: 0 0 0.25rem 0; color: #1f2937;">${
                item.name
              }</h4>
              <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                ${item.quantity} ${item.unit} â€¢ ${item.category}
              </p>
            </div>
            <div class="item-expiry">
              <span class="badge badge-${
                daysUntil <= 3 ? "warning" : "success"
              }">
                ${daysUntil} days
              </span>
              <p style="margin: 0.25rem 0 0 0;">
                Exp: ${expiryDate.toLocaleDateString()}
              </p>
            </div>
          </div>
        `;
          })
          .join("");
      }

      // Save items to database
      saveItemsBtn.addEventListener("click", async () => {
        if (!extractedData) {
          alert("No data to save");
          return;
        }

        try {
          const response = await fetch("/api/scan/save-items", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              receiptId: extractedData._id,
            }),
          });

          const result = await response.json();

          if (result.success) {
            alert(`Successfully saved ${result.itemsSaved} items!`);
            window.location.href = "/dashboard";
          } else {
            alert("Error saving items: " + (result.error || "Unknown error"));
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error saving items: " + error.message);
        }
      });
    </script>

    <%- include('partials/footer') %>
  </body>
</html>
