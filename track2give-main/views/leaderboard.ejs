<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaderboard - Track2Give</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="icon" href="/images/favicon.ico" />
  </head>
  <body>
    <%- include('partials/header') %>

    <%
      const formatNumber = (value, digits = 0) => {
        if (
          value === null ||
          value === undefined ||
          Number.isNaN(Number(value))
        ) {
          return digits > 0 ? Number(0).toFixed(digits) : "0";
        }
        return Number(value).toLocaleString("en-US", {
          minimumFractionDigits: digits,
          maximumFractionDigits: digits,
        });
      };

      const formatPercent = (value) => {
        if (
          value === null ||
          value === undefined ||
          Number.isNaN(Number(value))
        ) {
          return "N/A";
        }
        return `${value}%`;
      };

      const getRankLabel = (rank) => {
        if (rank === 1) return "1st";
        if (rank === 2) return "2nd";
        if (rank === 3) return "3rd";
        return `#${rank}`;
      };

      const sectionTitle = sort === "carbon" ? "Top Carbon Savers" : "Top Donors";
      const activeSortLabel = sort === "carbon" ? "carbon savings" : "items shared";
      const percentileDisplay =
        userRank && userRank.percentile !== null && userRank.percentile !== undefined
          ? formatPercent(100 - userRank.percentile)
          : "N/A";
    %>

    <main class="container leaderboard-page">
      <section class="leaderboard-header">
        <div class="leaderboard-heading">
          <p class="section-eyebrow">Community Impact</p>
          <h1 class="page-title">Leaderboard</h1>
          <p class="page-subtitle">
            Celebrate the donors and carbon savers powering Track2Give. Switch views to see who rescued the most meals
            or prevented the most CO₂.
          </p>
        </div>
        <div class="leaderboard-toggle" role="tablist" aria-label="Leaderboard sort">
          <a
            href="?sort=donations"
            class="leaderboard-toggle__option <%= sort === 'donations' ? 'is-active' : '' %>"
            role="tab"
            aria-selected="<%= sort === 'donations' %>"
          >
            Donations
          </a>
          <a
            href="?sort=carbon"
            class="leaderboard-toggle__option <%= sort === 'carbon' ? 'is-active' : '' %>"
            role="tab"
            aria-selected="<%= sort === 'carbon' %>"
          >
            Carbon
          </a>
        </div>
      </section>

      <section class="leaderboard-summary">
        <article class="leaderboard-summary-card">
          <h3 class="leaderboard-summary-title">Total Donations</h3>
          <p class="leaderboard-summary-value"><%= formatNumber(globalStats.totalItemsShared) %></p>
          <p class="leaderboard-summary-caption">Items shared across the community</p>
        </article>
        <article class="leaderboard-summary-card">
          <h3 class="leaderboard-summary-title">Carbon Saved</h3>
          <p class="leaderboard-summary-value highlight"><%= formatNumber(globalStats.totalCO2SavedKg, 2) %> kg</p>
          <p class="leaderboard-summary-caption">Food waste avoided through sharing</p>
        </article>
        <article class="leaderboard-summary-card">
          <h3 class="leaderboard-summary-title">Active Donors</h3>
          <p class="leaderboard-summary-value"><%= formatNumber(globalStats.totalUsers) %></p>
          <p class="leaderboard-summary-caption">People contributing to the impact</p>
        </article>
        <article class="leaderboard-summary-card">
          <h3 class="leaderboard-summary-title">Available Items</h3>
          <p class="leaderboard-summary-value"><%= formatNumber(globalStats.totalAvailableItems) %></p>
          <p class="leaderboard-summary-caption">Ready to be rescued right now</p>
        </article>
      </section>

      <section class="leaderboard-user">
        <% if (userRank.rank) { %>
          <div class="leaderboard-user-card">
            <div class="leaderboard-user-copy">
              <p class="section-eyebrow light">Your Impact</p>
              <h2 class="leaderboard-user-title">
                Ranked <span><%= userRank.rank %></span> of <%= formatNumber(userRank.totalDonors) %> donors
              </h2>
              <p class="leaderboard-user-subtitle">
                You're performing better than <strong><%= percentileDisplay %></strong> of the community. Keep sharing to climb!
              </p>
            </div>
            <div class="leaderboard-user-stats">
              <div class="leaderboard-user-stat">
                <span class="label">Items Shared</span>
                <span class="value"><%= formatNumber(userRank.itemsShared) %></span>
              </div>
              <div class="leaderboard-user-stat">
                <span class="label">CO₂ Saved</span>
                <span class="value"><%= formatNumber(userRank.co2SavedKg, 2) %> kg</span>
              </div>
            </div>
          </div>
        <% } else { %>
          <div class="leaderboard-user-card is-empty">
            <div class="leaderboard-user-copy">
              <p class="section-eyebrow">Kickoff Impact</p>
              <h2 class="leaderboard-user-title">Start your impact journey</h2>
              <p class="leaderboard-user-subtitle">
                Share your first item to appear on the leaderboard, inspire neighbours, and keep emissions out of the atmosphere.
              </p>
            </div>
            <div class="leaderboard-user-actions">
              <a href="/donate" class="btn btn-primary btn-lg">Share Food Now</a>
              <a href="/leaderboard?sort=carbon" class="btn btn-secondary btn-lg">View Carbon Rankings</a>
            </div>
          </div>
        <% } %>
      </section>

      <section class="card leaderboard-table">
        <div class="card-header">
          <div>
            <h2 class="card-title"><%= sectionTitle %></h2>
            <p class="card-subtitle">
              Showing top <%= limit %> contributors sorted by <%= activeSortLabel %>.
            </p>
          </div>
        </div>

        <% if (!leaderboardEntries || leaderboardEntries.length === 0) { %>
          <div class="leaderboard-empty">
            <p>No impact data yet. Be the first to donate and see your name here!</p>
          </div>
        <% } else { %>
          <div class="leaderboard-table-wrapper">
            <table class="impact-table">
              <thead>
                <tr>
                  <th scope="col">Rank</th>
                  <th scope="col">Member</th>
                  <th scope="col">Items Shared</th>
                  <th scope="col">Items Saved</th>
                  <th scope="col">CO₂ Saved (kg)</th>
                </tr>
              </thead>
              <tbody>
                <% leaderboardEntries.forEach((entry) => { %>
                  <%
                    const entryUserId = String(entry.userId);
                    const isCurrentUser = currentUserId && entryUserId === String(currentUserId);
                    const rankClass = entry.rank <= 3 ? `is-top-${entry.rank}` : "";
                  %>
                  <tr class="<%= isCurrentUser ? 'is-current' : '' %> <%= rankClass %>">
                    <td data-label="Rank">
                      <span class="leaderboard-rank-badge <%= entry.rank <= 3 ? 'is-top-' + entry.rank : '' %>">
                        <%= getRankLabel(entry.rank) %>
                      </span>
                    </td>
                    <td data-label="Member">
                      <div class="leaderboard-member">
                        <% if (entry.profilePicture) { %>
                          <img
                            src="<%= entry.profilePicture %>"
                            alt="<%= entry.username %> profile picture"
                            class="leaderboard-member-avatar"
                          />
                        <% } else { %>
                          <div class="leaderboard-member-avatar placeholder">
                            <%= entry.username ? entry.username.charAt(0).toUpperCase() : "?" %>
                          </div>
                        <% } %>
                        <div class="leaderboard-member-details">
                          <p class="name"><%= entry.username %></p>
                          <% if (isCurrentUser) { %>
                            <span class="badge badge-success">You</span>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td data-label="Items Shared"><%= formatNumber(entry.itemsShared) %></td>
                    <td data-label="Items Saved"><%= formatNumber(entry.itemsSaved) %></td>
                    <td data-label="CO₂ Saved (kg)"><%= formatNumber(entry.co2SavedKg, 2) %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } %>
      </section>
    </main>

    <%- include('partials/footer') %>
  </body>
</html>
